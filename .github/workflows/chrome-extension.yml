name: Build and Release Extension

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci || npm install

    - name: Build and Pack All Versions
      run: npm run pack:all

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: extension-packages
        path: build/*.zip
        retention-days: 30

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v2
      with:
        files: build/*.zip
        name: Release ${{ github.ref_name }}
        body: |
          ## ğŸš€ çŸ³å¢¨æ–‡æ¡£å¯¼å‡ºå·¥å…·å‘å¸ƒ
          
          ### ğŸ“¦ ä¸‹è½½å®‰è£…åŒ…
          - [Chrome ç‰ˆæœ¬] (shimo-export-chrome.zip)
          - [Firefox ç‰ˆæœ¬] (shimo-export-firefox.zip)
          - [Edge ç‰ˆæœ¬] (shimo-export-edge.zip)
          
          ### ğŸ”§ ä¸»è¦åŠŸèƒ½
          - âœ… è·¨æµè§ˆå™¨æ”¯æŒ (Chrome, Firefox, Edge)
          - âœ… ä¸€é”®æ‰¹é‡å¯¼å‡ºçŸ³å¢¨æ–‡æ¡£
          - âœ… æ”¯æŒå¤šç§æ ¼å¼: Markdown, PDF, Word, JPG
          - âœ… ä¿ç•™åŸå§‹æ–‡ä»¶å¤¹å±‚çº§ç»“æ„
          - âœ… å®æ—¶è¿›åº¦æ˜¾ç¤ºä¸å¯¼å‡ºæ€§èƒ½ç›‘æ§
          
          ### ğŸ“ æ›´æ–°è¯´æ˜
          è§æäº¤å†å²è®°å½•ã€‚
          
          ---
          **æ³¨æ„**: è¯·æ ¹æ®æ‚¨çš„æµè§ˆå™¨ä¸‹è½½å¯¹åº”çš„å®‰è£…åŒ…ï¼Œå¹¶åœ¨æµè§ˆå™¨æ‰©å±•ç®¡ç†é¡µé¢å¼€å¯å¼€å‘è€…æ¨¡å¼åâ€œåŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åºâ€ã€‚
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
