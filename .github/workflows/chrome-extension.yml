name: Build and Release Chrome Extension

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        # å¦‚æœæœ‰package.jsonï¼Œå®‰è£…ä¾èµ–
        if [ -f "package.json" ]; then
          npm ci
        fi

    - name: Validate manifest.json
      run: |
        # æ£€æŸ¥ manifest.json è¯­æ³•
        if ! python3 -m json.tool manifest.json > /dev/null; then
          echo "âŒ manifest.json è¯­æ³•é”™è¯¯"
          exit 1
        fi
        echo "âœ… manifest.json è¯­æ³•æ­£ç¡®"

    - name: Check required files
      run: |
        required_files=("manifest.json" "popup.html" "popup.js" "background.js" "settings.html" "settings.js")
        for file in "${required_files[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ ç¼ºå°‘å¿…éœ€æ–‡ä»¶: $file"
            exit 1
          fi
        done
        echo "âœ… æ‰€æœ‰å¿…éœ€æ–‡ä»¶éƒ½å­˜åœ¨"

    - name: Validate HTML files
      run: |
        # ç®€å•çš„ HTML éªŒè¯
        for html_file in popup.html settings.html; do
          if ! grep -q "<!DOCTYPE html>" "$html_file"; then
            echo "âŒ $html_file ç¼ºå°‘ DOCTYPE å£°æ˜"
            exit 1
          fi
        done
        echo "âœ… HTML æ–‡ä»¶æ ¼å¼æ­£ç¡®"

    - name: Create extension package
      run: |
        # åˆ›å»ºå‘å¸ƒåŒ…
        zip -r chrome-extension.zip . -x "*.DS_Store" "*.git*" ".github/*" "README.md" "INSTALL.md"
        echo "âœ… Chrome æ‰©å±•æ‰“åŒ…å®Œæˆ"

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: chrome-extension
        path: chrome-extension.zip
        retention-days: 30

  release:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: chrome-extension
        path: .

    - name: Extract version from tag
      id: get_version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Chrome Extension ${{ steps.get_version.outputs.version }}
        body: |
          ## ğŸ‰ Chrome æ‰©å±•å‘å¸ƒ
          
          ### ç‰ˆæœ¬: ${{ steps.get_version.outputs.version }}
          
          ### ğŸ“¦ å®‰è£…æ–¹æ³•
          
          #### æ–¹æ³•ä¸€ï¼šå¼€å‘è€…æ¨¡å¼å®‰è£…
          1. ä¸‹è½½ `chrome-extension.zip` æ–‡ä»¶
          2. è§£å‹åˆ°æœ¬åœ°æ–‡ä»¶å¤¹
          3. æ‰“å¼€ Chrome æµè§ˆå™¨ï¼Œè¿›å…¥ `chrome://extensions/`
          4. å¼€å¯"å¼€å‘è€…æ¨¡å¼"
          5. ç‚¹å‡»"åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº"
          6. é€‰æ‹©è§£å‹åçš„æ–‡ä»¶å¤¹
          
          #### æ–¹æ³•äºŒï¼šæ‰“åŒ…å®‰è£…
          1. ä¸‹è½½ `chrome-extension.zip` æ–‡ä»¶
          2. è§£å‹åˆ°æœ¬åœ°æ–‡ä»¶å¤¹
          3. åœ¨ `chrome://extensions/` é¡µé¢ç‚¹å‡»"æ‰“åŒ…æ‰©å±•ç¨‹åº"
          4. é€‰æ‹©è§£å‹åçš„æ–‡ä»¶å¤¹
          5. ç”Ÿæˆ `.crx` æ–‡ä»¶åæ‹–æ‹½å®‰è£…
          
          ### ğŸ”§ ä¸»è¦åŠŸèƒ½
          - âœ… è‡ªåŠ¨è·å–ç”¨æˆ·è®¤è¯
          - âœ… æ”¯æŒå¤šç§å¯¼å‡ºæ ¼å¼ (MD, PDF, DOCX, JPG)
          - âœ… æ‰¹é‡å¯¼å‡ºæ‰€æœ‰æ–‡ä»¶
          - âœ… ä¿ç•™åŸå§‹æ–‡ä»¶å¤¹ç»“æ„
          - âœ… å®æ—¶è¿›åº¦æ˜¾ç¤º
          - âœ… æš‚åœ/ç»§ç»­åŠŸèƒ½
          - âœ… å¤±è´¥é‡è¯•æœºåˆ¶
          - âœ… æ€§èƒ½ç›‘æ§
          
          ### ğŸ“ æ›´æ–°å†…å®¹
          - ä¼˜åŒ–äº†ä»£ç ç»“æ„ï¼Œç§»é™¤äº†ä¸å¿…è¦çš„ content script
          - æ”¹è¿›äº†é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º
          - å¢å¼ºäº†æ€§èƒ½ç›‘æ§åŠŸèƒ½
          - ä¼˜åŒ–äº†UIç•Œé¢è®¾è®¡
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. ç¡®ä¿å·²ç™»å½• [çŸ³å¢¨æ–‡æ¡£](https://shimo.im)
          2. ç‚¹å‡»æµè§ˆå™¨å·¥å…·æ ä¸­çš„æ‰©å±•å›¾æ ‡
          3. é€‰æ‹©å¯¼å‡ºæ ¼å¼
          4. ç‚¹å‡»"è·å–æ–‡ä»¶ä¿¡æ¯"
          5. ç‚¹å‡»"å¼€å§‹å¯¼å‡º"
          
          ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
          - Chrome æµè§ˆå™¨ 88+
          - å·²ç™»å½•çŸ³å¢¨æ–‡æ¡£è´¦å·
          
          ### ğŸ”’ å®‰å…¨è¯´æ˜
          - æ‰€æœ‰æ“ä½œåœ¨æœ¬åœ°è¿›è¡Œï¼Œä¸ä¸Šä¼ ä»»ä½•æ•°æ®
          - ä½¿ç”¨ Chrome åŸç”Ÿ APIï¼Œå®‰å…¨å¯é 
          - ä»…ç”¨äºä¸ªäººå­¦ä¹ å’Œåˆæ³•ç”¨é€”
          
          ---
          
          **æ³¨æ„**: ä½¿ç”¨æœ¬å·¥å…·æ—¶è¯·éµå®ˆçŸ³å¢¨æ–‡æ¡£çš„ä½¿ç”¨æ¡æ¬¾ã€‚
        draft: false
        prerelease: false

    - name: Upload Chrome Extension
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: chrome-extension.zip
        asset_name: chrome-extension-${{ steps.get_version.outputs.version_number }}.zip
        asset_content_type: application/zip

    - name: Create source code archive
      run: |
        # åˆ›å»ºæºä»£ç å‹ç¼©åŒ…
        git archive --format=zip --output=source-code-${{ steps.get_version.outputs.version_number }}.zip HEAD

    - name: Upload Source Code
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: source-code-${{ steps.get_version.outputs.version_number }}.zip
        asset_name: source-code-${{ steps.get_version.outputs.version_number }}.zip
        asset_content_type: application/zip

  notify:
    needs: release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: Notify release
      run: |
        echo "ğŸ‰ Chrome æ‰©å±•å·²æˆåŠŸå‘å¸ƒåˆ° GitHub Releases!"
        echo "ç‰ˆæœ¬: ${{ github.ref_name }}"
        echo "ä¸‹è½½åœ°å€: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}" 